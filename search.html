<!DOCTYPE html>
<meta charset="utf-8">

<head>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>

    <script language="javascript" src="https://www.biodalliance.org/release-0.13/dalliance-compiled.js"></script>

    <script src="https://d3js.org/colorbrewer.v1.min.js"></script>
    <script src="https://d3js.org/d3.v4.min.js" charset="utf-8"></script>

    <link href="resources/data/out.hdf5" />
    <script src="https://cdn.jsdelivr.net/gh/usnistgov/jsfive@master/dist/hdf5.js"></script>

    <script src="resources/js/circviewer.js"></script>
    <script src="resources/js/genomebrowser.js"></script>
    <script src="resources/js/heatmap.js"></script>
    <script src="resources/js/qtlPanel.js"></script>
    <script src="resources/js/lmsPanel.js"></script>

    <script src="resources/js/plot.js"></script>
    <script src="resources/js/panelManager.js"></script>
    <script src="resources/js/plotControls.js"></script>


    <link rel="stylesheet" href="resources/css/style.css" />
</head>

<body>
    <!-- Loading Animation -->
    <div id="my_loading" class="d-flex flex-row justify-content-center align-items-center" style="height: 100%">
        <div class="loader">
            <span class="sr-only">Loading...</span>
        </div>
    </div>

    <!-- Modal -->
    <div class="modal fade" id="myModal" role="dialog">
        <div class="modal-dialog" style="width: 70%">
            <div class="modal-content rounded-0" style="padding: 10px">
                <div class="modal-header">
                    <h4 id="myModalTitle" class="modal-title">Modal Header</h4>
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                </div>
                <div id="myModalBody" class="modal-body">
                    <span id="allpanels">
                        <div class="panel-group">
                            <div class="panel panel-default">
                                <div class="panel-heading">
                                    <h4 class="panel-title">
                                        <a data-toggle="collapse" href="#collapse1">Genome browser view</a>
                                    </h4>
                                </div>
                                <div id="collapse1" class="panel-collapse collapse in">
                                    <div class="panel-body">
                                        <div id="myGenomeBrowser"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="panel-group">
                            <div class="panel panel-default">
                                <div class="panel-heading">
                                    <h4 class="panel-title">
                                        <a data-toggle="collapse" href="#collapse2">Found in datasets/databases</a>
                                    </h4>
                                </div>
                                <div id="collapse2" class="panel-collapse collapse in">
                                    <div class="panel-body">
                                        <div id="myHeatmap" align="center"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </span>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Body -->
    <div>
        <nav class="navbar navbar-fixed-top">
            <div class="container-fluid">
                <div class="navbar-header">
                    <a class="navbar-brand">NeuroCirc</a>
                </div>
                <ul class="nav navbar-nav">
                    <li><a href="./index.html">About</a></li>
                    <li class="active"><a href="./search.html">Search</a></li>
                </ul>
            </div>
        </nav>

        <div id="myDiv" style="display:none;" class="container-fluid">
            <!--class animate-bottom-->
            <br>
            <br>
            <br>
            <br>
            <input type="search" autocomplete="off" id="myInput" placeholder="Search for circ_id or gene_symbol.."
                title="Type in an ID">

            <!-- Main Table -->
            <table class="table table-hover" style="width:100%" id="my_table"></table>

            <!-- Pagination -->
            <div id="my_pagination_container" class="container unselectable">
                <ul id="my_pagination" class="pagination"></ul>
            </div>
        </div>
    </div>

    <script>
        var genomebrowser = undefined;
        var panels = [];
        var hdf5Data = undefined;
        var urls = {};
        var heatmap = undefined;
        var hdf5QTL = undefined;
        var qtlTable = undefined;
        var qtlIndices = undefined;

        //TODO: this is only non self-describing data 
        let datasets = ["Gokool", "Liu", "Org", "ESC_FBN", "SY5Y"];
        let databases = ["CircAtlas2", "CircBase", "CircFunBase", "Circpedia2", "RNADb"];
        let other = ["circ_id", "chr", "start_hg38", "end_hg38", "start_hg19", "end_hg19", "strand", "gene_symbol", "ensembl_id"]
        let headings = other.concat(datasets).concat(databases);
        let datasetsStart = other.length;
        let datasetsEnd = other.length + datasets.length;
        let matrix = undefined;
        let indices = undefined;

        let sortCurrCol = -1;
        let sortCurrIndex = 0;
        let sortClassOrder = ["both", "desc", "asc"];

        let pageSize = 50;
        let pageCurr = 0;
        let pageMax = 5;

        let searchTerm = "";

        //TODO convert to promises. Very hacky 
        var awaitAll = 0;
        function incAwaitAll() {
            if (++awaitAll == 1) {
                hideLoading();
            }
        }

        let windowPath = window.location.href.substring(0, window.location.href.lastIndexOf('/'));

        fetch(windowPath + "/resources/data/out.hdf5")
            .then(function (response) {
                return response.arrayBuffer()
            })
            .then(function (buffer) {
                var f = new hdf5.File(buffer, "");
                var panelContainer = document.getElementById("allpanels");;
                var charts = f.get('charts');
                
                let parentId = "allpanels";
                let panelNames = ["CircRNA expression in human brain tissue","Neuronal cell differentiation", "Celullar maturation"];

                let i = 0;
                for(let group of panelNames) {
                    let groupObj = charts.get(group);
                    panels.push(new PanelManager(parentId, parentId + i, groupObj, group));
                    ++i;
                }

                hdf5Data = f.get("data");
                matrix = [];
                for(let h of headings) matrix.push([...hdf5Data.get(h).value]);
                indices = new Array(matrix[0].length);

                let urlsGroup = f.get("urls");
                for(let k of urlsGroup.keys) {
                    let dataset = urlsGroup.get(k);
                    urls[k] = {urls: dataset.value, home: dataset.attrs.home, prefix: dataset.attrs.prefix}
                }
                qtlIndices = [...f.get("tables/QTL Analysis Brain/Liu/indices").value];
                hdf5QTL = f.get("tables/QTL Analysis Brain/Liu/QTL");
                qtlTable = new QTLPanel("allpanels", 2, "QTL Analysis Brain", hdf5QTL.attrs.heading.split(","));
                

                lmsMeta = {};
                for(let i=other.length; i<other.length + datasets.length; ++i) lmsMeta[headings[i]] = matrix[i];
                lmsPanel = new LMSPanel("allpanels", 1, "Dataset comparison (log mean scale)", f, lmsMeta);

                i = 0;
                for(let x of document.getElementsByClassName("panel-body")) {
                    if(i++ > 1) {
                        x.insertAdjacentHTML("afterbegin", '<div>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Proin fermentum sem a nibh tempor, non rutrum ipsum molestie. Suspendisse sagittis hendrerit aliquam. In posuere nisl sit amet ultrices pretium. Sed vel turpis faucibus, congue nibh in, varius ligula. Donec ac enim et tortor finibus mollis et eget mi. Cras eu orci sit amet augue rutrum consequat. Maecenas lorem ante, aliquam a cursus sit amet, facilisis eget magna. </div><br><br>')
                    }
                }

                makeTable();
                incAwaitAll();
            });

        genomebrowser = new GenomeBrowser("myGenomeBrowser");
        heatmap = new Heatmap("myHeatmap");

        $("#myInput").keyup(function (event) {
            if (event.keyCode === 13) {
                searchTerm = $("#myInput").val().trim().toLowerCase();
                pageCurr = 0;
                makeTable();
            }
        });

        function hideLoading() {
            document.getElementById("my_loading").style.display = "none";
            document.getElementById("myDiv").style.display = "block";
        }

        function makeTable() {
            let tableContents = "";
            tableContents += '<thead>';
            tableContents += "<tr>";
            for (let i=0; i<headings.length; ++i) {
                let h = headings[i];
                sortClass = ((i == sortCurrCol) ? sortClassOrder[sortCurrIndex] : "both");
                let dtypeRes = hdf5Data.get(h).dtype.match(/([A-Z])([0-9]+)/i);
                let dtypeStyle = "";
                if(dtypeRes && dtypeRes[1].toLowerCase() == "s") {
                    dtypeStyle = ' style="width:' + (0.725 * Math.max(h.length+5, parseInt(dtypeRes[2])) * 14) + 'px;" ';
                }

                if (datasets.includes(h) || databases.includes(h)) {
                    tableContents += '<th ' + dtypeStyle + 'class="bool"><span id="' + h + '"class="unselectable sortable ' + sortClass + '">' + h + "</span></th>";
                } else {
                    tableContents += '<th' + dtypeStyle + '><span id="' + h + '"class="unselectable sortable ' + sortClass + '">' + h + "</th>";
                }
            }
            tableContents += "</tr>";
            tableContents += "</thead>";
            tableContents += '<tbody>';
            
            for (var i=0; i < matrix[0].length; ++i) indices[i] = i;
            if(sortCurrCol >= 0) {
                if(sortClassOrder[sortCurrIndex] == "asc") {
                    indices.sort(function (a, b) { return matrix[sortCurrCol][a] < matrix[sortCurrCol][b] ? -1 : matrix[sortCurrCol][a] > matrix[sortCurrCol][b] ? 1 : 0; });
                } else if(sortClassOrder[sortCurrIndex] == "desc") {
                    indices.sort(function (a, b) { return matrix[sortCurrCol][a] > matrix[sortCurrCol][b] ? -1 : matrix[sortCurrCol][a] < matrix[sortCurrCol][b] ? 1 : 0; });
                }
            }
            
            let total=0;
            console.log(`pageCurr: ${pageCurr}, pageSize: ${pageSize}`);
            for(let i=0; i<matrix[0].length; ++i) {
                let sortIndex = indices[i];

                //Skip if doesn't match search
                if(!(matrix[0][sortIndex].toLowerCase().includes(searchTerm) || matrix[7][sortIndex].toLowerCase().includes(searchTerm))) continue;
                
                ++total;

                //Skip if not on page
                if(total <= (pageCurr * pageSize) || total > ((pageCurr + 1) * pageSize)) continue;
                //total < 50 || total > 100

                tableContents += `<tr data-index="${sortIndex}">`;
                for(let j=0; j<headings.length; ++j) {
                    let e = matrix[j][sortIndex];
                    if (datasets.includes(headings[j])) { //TODO super hacky, this info should be in db
                        tableContents += `<td class="${(e != -1 ? 'bool yes dataset' : 'bool no')}" data-metaindex="${e}"></td>`;
                    } else if (databases.includes(headings[j])) {
                        tableContents += `<td class="${(e != -1 ? 'bool yes database' : 'bool no')}" data-metaindex="${e}"></td>`;
                    } else {
                        tableContents += '<td>' + e + "</td>";
                    }
                }
                tableContents += "</tr>";
            }
            tableContents += '</tbody>';
            document.getElementById("my_table").innerHTML = tableContents;

            $("#myInput")[0].setCustomValidity(total ? "" : "No results");

            $("thead > tr > th > span").click(function (arg) {
                sortNewCol = headings.indexOf(arg.target.id);
                if (sortCurrCol == sortNewCol) {
                    sortCurrIndex = (sortCurrIndex + 1) % 3;
                } else {
                    sortCurrIndex = 1;
                }
                sortCurrCol = sortNewCol;
                makeTable();
            });

            $("tbody > tr").click(function (arg) {
                if (getSelection().toString()) {
                    return; //user selected text, not a click
                }
                let circindex = parseInt(arg.currentTarget.getAttribute("data-index"));

                genomebrowser.setPosition(matrix[1][circindex], matrix[2][circindex], matrix[3][circindex]);
                
                let metaIndex = new Array(headings.length);

                //Change heatmap
                heatmapObj = []
                for(let i=other.length; i<headings.length; ++i) {
                    metaIndex[i] = parseInt(arg.currentTarget.children[i].getAttribute("data-metaindex"));
                    present = (metaIndex[i] != -1);
                    let url = "";
                    if(present) {
                        let urlObj = urls[headings[i]];
                        if(urlObj) {
                            if(urlObj.prefix) {
                                url = urlObj.prefix + urlObj.urls[metaIndex[i]];
                                console.log(metaIndex[i]);
                                console.log(urlObj.urls)
                            } else {
                                url = urlObj.home;
                            }
                        }
                    }
                    heatmapObj.push({name: headings[i], url: url, present: present, isDataset: (i < datasetsEnd)});
                }
                heatmap.update(heatmapObj);

                //Change metadata panels
                metadataObj = {};
                for(let i=datasetsStart; i<datasetsEnd; ++i) metadataObj[headings[i]] = metaIndex[i];
                for (let p of panels) p.setCircId(matrix[0][circindex], metadataObj);

                //Change QTL table
                let qtl = undefined;
                
                if(matrix[10][circindex] >= 0) {
                    let qtlCalcIndex = qtlIndices[matrix[10][circindex]]
                    if(qtlCalcIndex >= 0) {
                        let end = -1;
                        for(let i = qtlCalcIndex + 1; i < qtlIndices.length; ++i) {
                            if(qtlIndices[i] >= 0) {
                                end = qtlIndices[i];
                                break;
                            }
                        }
                        qtl = hdf5QTL.value.slice(qtlCalcIndex, (end == -1 ? hdf5QTL.shape[0] : end));
                        for(let i=0; i<qtl.length; ++i) qtl[i] = qtl[i].split(",");
                    }
                    
                }
                qtlTable.setData(qtl);

                lmsPanel.setCircIndex(circindex);

                //console.log(hdf5QTL.value.slice(0, 110));

                //Show modal
                $("#myModalTitle").text("CircRNA: " + matrix[0][circindex])
                $("#myModal").modal('toggle')
            });

            let paginateContents = "";
            let pageCurrMax = Math.ceil(total / pageSize);
            let pageStart = Math.max(0, Math.floor(pageCurr+1-pageMax/2));
            let pageEnd = Math.min(pageCurrMax, pageStart + pageMax)
            if(pageStart > 0) paginateContents += '<li class="page-item"><a class="page-link" value="0">1</a></li>' + '<li class="page-item disabled"><a class="page-link">...</a></li>'
            for(let i=pageStart; i<pageEnd; ++i) paginateContents += '<li class="page-item ' + (i == pageCurr ? "page-current disabled" : "") + '"><a class="page-link" value="' + (i) +'">' + (i+1) + '</a></li>'
            if(pageEnd < pageCurrMax) paginateContents += '<li class="page-item disabled"><a class="page-link">...</a></li>' + '<li class="page-item"><a class="page-link" value="' + (pageCurrMax-1) +'">' + (pageCurrMax) + '</a></li>'
            paginateContents += '<li class="page-item ' + (pageCurr+1==pageCurrMax ? "disabled" : "")
            document.getElementById("my_pagination").innerHTML = paginateContents;

            $("#my_pagination > li").click(function (arg) {
                if(!$(arg.currentTarget).hasClass('disabled')) {
                    pageCurr = parseInt(arg.currentTarget.firstChild.getAttribute("value"));
                    makeTable();
                }
            });
        }
    </script>
</body>