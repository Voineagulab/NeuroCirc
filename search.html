<!DOCTYPE html>
<meta charset="utf-8">

<head>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>

    <script language="javascript" src="https://www.biodalliance.org/release-0.13/dalliance-compiled.js"></script>

    <script src="https://d3js.org/colorbrewer.v1.min.js"></script>
    <script src="https://d3js.org/d3.v4.min.js" charset="utf-8"></script>

    <link href="resources/data/out.hdf5" />
    <script src="https://cdn.jsdelivr.net/gh/usnistgov/jsfive@master/dist/hdf5.js"></script>

    <script src="resources/js/circviewer.js"></script>
    <script src="resources/js/genomebrowser.js"></script>

    <script src="resources/js/plot.js"></script>
    <script src="resources/js/panelManager.js"></script>
    <script src="resources/js/plotControls.js"></script>


    <link rel="stylesheet" href="resources/css/style.css" />
</head>

<body>
    <!-- Loading Animation -->
    <div id="my_loading" class="d-flex flex-row justify-content-center align-items-center" style="height: 100%">
        <div class="loader">
            <span class="sr-only">Loading...</span>
        </div>
    </div>

    <!-- Modal -->
    <div class="modal fade" id="myModal" role="dialog">
        <div class="modal-dialog" style="width: 70%">
            <div class="modal-content rounded-0" style="padding: 10px">
                <div class="modal-header">
                    <h4 id="myModalTitle" class="modal-title">Modal Header</h4>
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                </div>
                <div id="myModalBody" class="modal-body">
                    <span id="allpanels">
                        <div class="panel-group">
                            <div class="panel panel-default">
                                <div class="panel-heading">
                                    <h4 class="panel-title">
                                        <a data-toggle="collapse" href="#collapse1">Genome
                                            browser
                                            view</a>
                                    </h4>
                                </div>
                                <div id="collapse1" class="panel-collapse collapse in">
                                    <div class="panel-body">
                                        <div id="myGenomeBrowser"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </span>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Body -->
    <div>
        <nav class="navbar navbar-fixed-top">
            <div class="container-fluid">
                <div class="navbar-header">
                    <a class="navbar-brand">NeuroCirc</a>
                </div>
                <ul class="nav navbar-nav">
                    <li><a href="./index.html">About</a></li>
                    <li class="active"><a href="./search.html">Search</a></li>
                </ul>
            </div>
        </nav>

        <div id="myDiv" style="display:none;" class="container-fluid">
            <!--class animate-bottom-->
            <br>
            <br>
            <br>
            <br>
            <input type="search" autocomplete="off" id="myInput" placeholder="Search for circ_id or gene_symbol.."
                title="Type in an ID">

            <!-- Main Table -->
            <table class="table table-hover" style="width:100%" id="my_table"></table>
        </div>
    </div>

    <script>
        var genomebrowser = undefined;
        var panels = [];
        var hdf5Data = undefined;

        let datasets = ["Gokool", "Liu", "Org", "ESC_FBN", "SY5Y"];
        let databases = ["CircAtlas2", "CircBase", "CircFunBase", "Circpedia2", "RNADb"];
        let other = ["circ_id", "chr", "start_hg38", "end_hg38", "start_hg19", "end_hg19", "strand", "gene_symbol", "ensembl_id"]
        let headings = other.concat(datasets).concat(databases);
        let datasetsStart = other.length;
        let datasetsEnd = other.length + datasets.length;
        let matrix = [];

        let sortCurrCol = -1;
        let sortCurrIndex = 0;
        let sortClassOrder = ["both", "desc", "asc"];

        let searchTerm = "";

        //TODO convert to promises. Very hacky 
        var awaitAll = 0;
        function incAwaitAll() {
            if (++awaitAll == 1) {
                hideLoading();
            }
        }

        let windowPath = window.location.href.substring(0, window.location.href.lastIndexOf('/'));

        fetch(windowPath + "/resources/data/out.hdf5")
            .then(function (response) {
                return response.arrayBuffer()
            })
            .then(function (buffer) {
                var f = new hdf5.File(buffer, "");
                var panelContainer = document.getElementById("allpanels");;
                var charts = f.get('charts');
                
                let parentId = "allpanels";
                let panelNames = ["CircRNA expression in human brain tissue","Neuronal cell differentiation", "Celullar maturation"];

                let i = 0;
                for(let group of panelNames) {
                    let groupObj = charts.get(group);
                    panels.push(new PanelManager(parentId, parentId + i, groupObj, group));
                    ++i;
                }

                hdf5Data = f.get("data");
                matrix = [];
                for(let h of headings) matrix.push([...hdf5Data.get(h).value]);

                makeTable();
                incAwaitAll();
            });

        genomebrowser = new GenomeBrowser("myGenomeBrowser");
       

        $("#myInput").keyup(function (event) {
            if (event.keyCode === 13) {
                searchTerm = $("#myInput").val().toLowerCase();
                makeTable();
            }
        });

        function hideLoading() {
            document.getElementById("my_loading").style.display = "none";
            document.getElementById("myDiv").style.display = "block";
        }

        function makeTable() {
            let tableContents = "";
            tableContents += '<thead>';
            tableContents += "<tr>";
            for (let i=0; i<headings.length; ++i) {
                let h = headings[i];
                sortClass = ((i == sortCurrCol) ? sortClassOrder[sortCurrIndex] : "both");
                let dtypeRes = hdf5Data.get(h).dtype.match(/([A-Z])([0-9]+)/i);
                let dtypeStyle = "";
                if(dtypeRes && dtypeRes[1].toLowerCase() == "s") {
                    dtypeStyle = ' style="width:' + (0.75 * Math.max(h.length+5, parseInt(dtypeRes[2])) * 14) + 'px;" ';
                    
                }

                if (datasets.includes(h) || databases.includes(h)) {
                    tableContents += '<th ' + dtypeStyle + 'class="bool"><span id="' + h + '"class="unselectable sortable ' + sortClass + '">' + h + "</span></th>";
                } else {
                    tableContents += '<th' + dtypeStyle + '><span id="' + h + '"class="unselectable sortable ' + sortClass + '">' + h + "</th>";
                }
            }
            tableContents += "</tr>";
            tableContents += "</thead>";
            tableContents += '<tbody>';
            
            var indices = new Array(matrix[0].length);
            for (var i=0; i < matrix[0].length; ++i) indices[i] = i;
            if(sortCurrCol >= 0) {
                if(sortClassOrder[sortCurrIndex] == "asc") {
                    indices.sort(function (a, b) { return matrix[sortCurrCol][a] < matrix[sortCurrCol][b] ? -1 : matrix[sortCurrCol][a] > matrix[sortCurrCol][b] ? 1 : 0; });
                } else if(sortClassOrder[sortCurrIndex] == "desc") {
                    indices.sort(function (a, b) { return matrix[sortCurrCol][a] > matrix[sortCurrCol][b] ? -1 : matrix[sortCurrCol][a] < matrix[sortCurrCol][b] ? 1 : 0; });
                }
            }
            
            let limit=0;
            for(let i=0; i<matrix[0].length && limit<50; ++i) {
                tableContents += "<tr>";
                let sortIndex = indices[i];

                //Skip if doesn't match search
                if(!(matrix[0][sortIndex].toLowerCase().includes(searchTerm) || matrix[7][sortIndex].toLowerCase().includes(searchTerm))) continue;
                
                ++limit;

                for(let j=0; j<headings.length; ++j) {
                    let e = matrix[j][sortIndex];
                    if (datasets.includes(headings[j])) { //TODO super hacky, this info should be in db
                        tableContents += '<td class="' + (e >= 0 ? 'bool yes dataset' : 'bool no') + '">' + e + '</td>';
                    } else if (databases.includes(headings[j])) {
                        tableContents += '<td class="' + (e >= 0 ? 'bool yes database' : 'bool no') + '">' + e + '</td>';
                    } else {
                        tableContents += '<td>' + e + "</td>";
                    }
                }
                tableContents += "</tr>";
            }
            tableContents += '</tbody>';
            document.getElementById("my_table").innerHTML = tableContents;

            $("#myInput")[0].setCustomValidity(limit ? "" : "No results");

            $("thead > tr > th > span").click(function (arg) {
                sortNewCol = headings.indexOf(arg.target.id);
                if (sortCurrCol == sortNewCol) {
                    sortCurrIndex = (sortCurrIndex + 1) % 3;
                } else {
                    sortCurrIndex = 1;
                }
                sortCurrCol = sortNewCol;
                makeTable();
            });

            $("tbody > tr").click(function (arg) {
                if (getSelection().toString()) {
                    return; //user selected text, not a click
                }
                let circ = arg.currentTarget.children[0].textContent;

                genomebrowser.setPosition(arg.currentTarget.children[1].textContent, parseInt(arg.currentTarget.children[2].textContent), parseInt(arg.currentTarget.children[3].textContent));

                obj = {};
                for(let i=datasetsStart; i<datasetsEnd; ++i) obj[headings[i].toLowerCase()] = arg.currentTarget.children[i].textContent;
                for (let p of panels) p.setCircId(circ, obj);

                $("#myModalTitle").text("CircRNA: " + circ)
                $("#myModal").modal('toggle')
            });
        }
    </script>
</body>